name: Build

on:
  workflow_dispatch:
  pull_request:

jobs:
  build-and-run:
    runs-on: ubuntu-latest

    steps:
      - name: Check out source code
        uses: actions/checkout@v4
        with:
          submodules: recursive

      - name: Install dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y \
            build-essential meson ninja-build cmake pkg-config \
            gcc g++ clang \
            rustc cargo \
            libx11-dev libx11-xcb-dev libxext-dev libxres-dev \
            libxcb1-dev libxcb-composite0-dev libxcb-xfixes0-dev \
            libxcb-randr0-dev libxcb-shape0-dev libxcb-util-dev \
            libxrender-dev libxtst-dev libxdamage-dev libxcomposite-dev \
            libxcursor-dev libxxf86vm-dev libxmu-dev \
            libxkbcommon-dev \
            libwayland-dev libwayland-server wayland-protocols \
            libvulkan-dev \
            libdrm-dev libgbm-dev libegl1-mesa-dev libgles2-mesa-dev \
            libpipewire-0.3-dev \
            libpixman-1-dev libudev-dev libsdl2-dev \
            libseat-dev \
            libinput-dev \
            libxcb-ewmh-dev libxcb-icccm4-dev libxcb-res0-dev \
            xserver-xorg-dev \
            libsystemd-dev \
            libdecor-0-dev \
            glslang-dev glslang-tools \
            libcap-dev \
            libavif-dev libheif-dev libaom-dev librav1e-dev \
            luajit

      - name: Build with gcc
        run: |
          cd deps/gamescope
          export CC=gcc CXX=g++
          meson build-gcc/ -Dinput_emulation=disabled --werror --auto-features=enabled
          ninja -C build-gcc/

      - name: Build gamescope
        run: |
          cd deps/gamescope
          export CC=gcc CXX=g++
          meson build-gcc-novr/ -Dinput_emulation=disabled -Denable_openvr_support=false --werror --auto-features=enabled
          ninja -C build-gcc-novr/

      - name: Build the rest
        run: |
          cd ..
          export CC=gcc CXX=g++
          meson build-gcc-novr/ -Dinput_emulation=disabled -Denable_openvr_support=false --werror --auto-features=enabled
          ninja -C build-gcc-novr/
